---
title: "Project 3"
author: "Aurora Hofman, Camilla Karlsen, Catharina Lilleengen"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---

#Problem 1 

##Teori
We are given the mixed model 
$$
  y_{ij} = \beta_0 + \gamma_i + \epsilon_{ij}, 
$$
where $\gamma_i$ are iid N$(0,\tau^2)$ and $\epsilon_{ij}$ are  iid N$(0,\sigma^2)$ for $i = 1,\ldots,m,  j = 1,\ldots n$. For each group $i = 1,\ldots,m$ we have 
$$
   y_{ij} = \boldsymbol{x}_{ij}^T\boldsymbol{\beta} + \boldsymbol{u}_{ij}\boldsymbol{\gamma}_i + \epsilon_{ij}. 
$$
To express the model in matrix notation we can write
$$
  \boldsymbol{y_i} = \boldsymbol{X_i}\boldsymbol{\beta} + \boldsymbol{U_i}\boldsymbol{\gamma_i} + \boldsymbol{\epsilon_i}, 
$$
so the model can be expressed as 
$$
  \boldsymbol{Y} = \boldsymbol{X}\boldsymbol{\beta} + \boldsymbol{U}\boldsymbol{\gamma} + \boldsymbol{\epsilon}.
$$
Here $\boldsymbol{Y} = [y_1 \ldots y_m]^T$, $\boldsymbol{X} = [x_1^T \ldots x_m^T]^T$, $\boldsymbol{\gamma} = [\gamma_1 \ldots \gamma_m]^T$, $ \boldsymbol{\epsilon}= [\epsilon_1^T \ldots \epsilon_m^T]^T$ and $\boldsymbol{U} = blockdiag(U_1, \ldots , U_m)$ where $U_i$ is a $(4\times 1)$-dimensional vector with ones. 
Here $\boldsymbol{X}$ and $\boldsymbol{U}$ are design matrices, $\boldsymbol{\beta}$ is the vector for fixed effects and $\boldsymbol{\gamma}$ the vector of random effects. In this case, 
$$
  \boldsymbol{\gamma} \sim N(0,G) \quad \textrm{and} \quad \boldsymbol{\epsilon} \sim N(0,R),  
$$
where $G = \tau^2I$ and $R = \sigma^2I$. 

Where in this case $\boldsymbol{x}_{ij}^T = 1$ and $\boldsymbol{u}_{ij}^T = 1$.
TEORIEN MÅ SKRIVE OM LITT ETTER VI HAR FUNNET UT AV VÅRT TILFELLE...
   
##Kode

```{r setup, include=TRUE}
data <- read.csv("https://www.math.ntnu.no/emner/TMA4315/2019h/random-intercept.csv",
  colClasses=c("numeric","factor"))
attach(data)
library(lme4)
lmer(y ~ (1|group), REML = TRUE)

```

```{r , include=TRUE}
library(lme4)

beta <- function(V,theta){
  beta=solve(T(X)*solve(V(theta))*X)*T(X)*solve(V(theta))*y
  return(beta)
}

V <- function(theta){
  V = R(theta) + U*G(theta)*T(U)
  return(V)
}
l_p <- function(theta){
  beta_est=beta(theta)
  l_p = -1/2*(log(abs(V(theta)))+(T(y-X*beta_est)*solve(V(theta))*(y-X*beta_est)))
  return(l_p)
}

l_r <- function(theta){
  l_r = l_p(theta)-1/2*log(determinant(T(X)*solve(V)*X))
  return(l_r)
}
```

```{r , include=TRUE}
mylmm <- function(y, group,REML=FALSE){ #i grupper #j obs i hver gruppe
  estimates=rep(0,3) #beta, sigma, tau
  m<-nlevels(group) #10 # number of clusters/individuals
  n<-length(y)/m # 4 number of measurements within each cluster
  U <- model.matrix(~0 + group)
  X <- matrix(1,m*n)
  
  
  #if REML=TRUE: 
  return(estimates)
}

mod <- lmer(y ~ (1|group), REML=TRUE)
summary(mod)
?optim


#Check the estimates
lmer(y ~ (1|group), REML=FALSE) 
lmer(y ~ (1|group), REML=TRUE)

```


#Problem 2