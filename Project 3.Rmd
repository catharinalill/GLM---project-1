---
title: "Project 3"
author: "Aurora Hofman, Camilla Karlsen, Catharina Lilleengen"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---

#Problem 1 

##Teori
We are given the mixed model 
$$
  y_{ij} = \beta_0 + \gamma_i + \epsilon_{ij}, 
$$
where $\gamma_i$ are iid $\mathcal{N}(0,\tau^2)$ and $\epsilon_{ij}$ are  iid $\mathcal{N}(0,\sigma^2)$ for $i = 1,\ldots,m,  j = 1,\ldots n$. This means we have the same number of observations for each group. We can also write the model as
$$
   y_{ij} = \boldsymbol{x}_{ij}^T\boldsymbol{\beta} + \boldsymbol{u}_{ij}\boldsymbol{\gamma}_i + \epsilon_{ij},  
$$
where in this case $\boldsymbol{x}_{ij}^T = 1$ and $\boldsymbol{u}_{ij}^T = 1$. For each group $i = 1,\ldots,m$ we have
$$
  \boldsymbol{y_i} = \boldsymbol{X_i}\boldsymbol{\beta} + \boldsymbol{U_i}\boldsymbol{\gamma_i} + \boldsymbol{\epsilon_i}.  
$$
Here $\boldsymbol{y_i}$ is a n-dimensional vector of response values for group $i$, $X_i$ are a $(n\times p)$-dimensional design matrix, and $p=1$ since we only have intercept in the model. Hence, $\boldsymbol{X_i}$ is a $(n\times 1)$-dimensional vector with only ones, since we do not have any covariates. $\boldsymbol{U_i}$ in this case is also a $(n\times 1)$-dimensional design matrix with only ones. The p-dimensional vector of fixed effects $\boldsymbol{\beta} = \beta_0$ in this case, and since we only have a random intercept model the vector of group-specific effects $\boldsymbol{\gamma_i}$ has dimension $1/times 1$. Moreover $\boldsymbol{\epsilon_i}$ is a n-dimensional vector of errors. The model can be expressed in matrix notation as,
$$
  \boldsymbol{Y} = \boldsymbol{X}\boldsymbol{\beta} + \boldsymbol{U}\boldsymbol{\gamma} + \boldsymbol{\epsilon}.
$$
Here $\boldsymbol{Y} = [y_1 \ldots y_m]^T$, $\boldsymbol{X} = [x_1^T \ldots x_m^T]^T$, $\boldsymbol{\gamma} = [\gamma_1 \ldots \gamma_m]^T$, $\boldsymbol{\epsilon}= [\epsilon_1^T \ldots \epsilon_m^T]^T$ and $\boldsymbol{U} = blockdiag(U_1, \ldots , U_m)$ where $U_i$ is a $(n\times 1)$-dimensional vector with ones. 
Here $\boldsymbol{X}$ and $\boldsymbol{U}$ are design matrices, $\boldsymbol{\beta}$ is the vector for fixed effects and $\boldsymbol{\gamma}$ the vector of random effects. In this case, 
$$
  \boldsymbol{\gamma} \sim N(0,G) \quad \textrm{and} \quad \boldsymbol{\epsilon} \sim N(0,R),  
$$
where $G = \tau^2I$ and $R = \sigma^2I$. 
   
##Kode

```{r setup, include=TRUE}
library(lme4)
data <- read.csv("https://www.math.ntnu.no/emner/TMA4315/2019h/random-intercept.csv",
  colClasses=c("numeric","factor"))
attach(data)


```

```{r , include=TRUE}

#Defining functions for beta(V), V(theta), l_p(theta), l_r(theta)

beta <- function(V){
  beta=solve(t(X)%*%solve(V)%*%X)%*%t(X)%*%solve(V)%*%y
  return(beta)
}

#Covariance matrix
V <- function(theta){
  R <- theta[1]*diag(n*m)
  G <- theta[2]*diag(m)
  V = R + U%*%G%*%t(U)
  return(V)
}

#profile log-likelihood
l_p <- function(theta){
  V = V(theta)
  beta_est=beta(V)
  l_p = -1/2*(log(det(V))+(t(y-X%*%beta_est)%*%solve(V)%*%(y-X%*%beta_est)))
  return(l_p)
}
#restricted log-likelihood
l_r <- function(theta){
  l_r = l_p(theta)-1/2*log(det(t(X)%*%solve(V(theta))%*%X))
  return(l_r)
}
```

```{r , include=TRUE}

#Define constands and design matrices X and U
  m<-nlevels(group)  # number of clusters/individuals
  n<-length(y)/m # number of measurements within each cluster
  U <- model.matrix(~0 + group)
  X <- matrix(1,m*n)

#Define mylmm
mylmm <- function(y, group,REML = FALSE){ 
  estimates=rep(0,3) #beta, sigma, tau
  theta <- rep(1,2) #sigma, tau
  
  #find theta trough numerical maximisation
  if (REML == FALSE) {
    obj = optim(par = theta,fn = l_p,control = list(fnscale=-1))
  }
  else {
    obj = optim(par = theta,fn = l_r,control = list(fnscale=-1))
  }
  
  #Extract estimated theta
  theta = obj$par
  #Estimated beta 
  beta = beta(V(theta))
  
  estimates[1] = beta
  estimates[2] = sqrt(theta[1])
  estimates[3] = sqrt(theta[2])
  return(estimates)
}

#Check the estimates against computed values by lmer fitted with maximum likelihood 
mylmm(y,group, REML = FALSE)
lmer(y ~ (1|group), REML=FALSE) 

#Check the estimates against computed values by lmer fitted with restricted maximum likelihood
mylmm(y,group, REML=TRUE)
lmer(y ~ (1|group), REML=TRUE)

```


#Problem 2